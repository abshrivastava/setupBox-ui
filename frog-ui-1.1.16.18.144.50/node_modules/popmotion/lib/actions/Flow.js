'use strict';

exports.__esModule = true;

var _Action2 = require('../actions/Action');

var _Action3 = _interopRequireDefault(_Action2);

var _generateBlendCurve = require('./flow/generate-blend-curve');

var _generateBlendCurve2 = _interopRequireDefault(_generateBlendCurve);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/*
  Methods and properties to add to bound Actions
*/
var boundOnStart = function (action) {
  return action.flow.activateAction(action.id, action);
};
var boundOnStop = function (action) {
  return action.flow.deactivateAction(action.id);
};
var boundProps = function (flow) {
  return {
    flow: flow,
    isPriority: true,
    onActivate: boundOnStart,
    onDeactivate: boundOnStop
  };
};

var Flow = function (_Action) {
  _inherits(Flow, _Action);

  function Flow(props) {
    _classCallCheck(this, Flow);

    var _this = _possibleConstructorReturn(this, _Action.call(this, props));

    _this.activeActions = {};
    _this.numActiveActions = 0;
    return _this;
  }

  Flow.prototype.set = function set(props) {
    _Action.prototype.set.call(this, props);

    this.once();

    return this;
  };

  /*
    Bind Action to Actor
  */


  Flow.prototype.connect = function connect(action) {
    var inheritedAction = action.inherit();
    var newValues = {};
    var hasNewValues = false;

    // Create values on actor that don't exist
    for (var key in inheritedAction.values) {
      if (inheritedAction.values.hasOwnProperty(key) && !this.values.hasOwnProperty(key)) {
        newValues[key] = {};
        hasNewValues = true;
      }
    }

    if (hasNewValues) {
      this.set({ values: newValues });
    }

    inheritedAction.parentId = action.id;

    return inheritedAction.set(boundProps(this, inheritedAction));
  };

  /*
    Start Actor
     If Action is provided, bind it to this Actor and start
     @param (optional) [Action]
  */


  Flow.prototype.start = function start() {
    _Action.prototype.start.call(this);

    for (var key in this.activeActions) {
      if (this.activeActions.hasOwnProperty(key)) {
        var action = this.activeActions[key];
        if (!action.isActive) {
          action.start();
        }
      }
    }

    return this;
  };

  Flow.prototype.stop = function stop() {
    _Action.prototype.stop.call(this);

    for (var key in this.activeActions) {
      if (this.activeActions.hasOwnProperty(key)) {
        this.activeActions[key].stop();
      }
    }

    return this;
  };

  Flow.prototype.willRender = function willRender(actor, frameStamp, elapsed) {
    for (var i = 0; i < this.numValueKeys; i++) {
      var key = this.valueKeys[i];
      var value = this.values[key];
      var driver = value.numDrivers ? this.activeActions[value.drivers[0]] : false;
      var newCurrent = value.numDrivers ? driver.values[key].current : value.current;

      /**
       * TODO: replace with blend tree resolver
       * Additive motion
       * Bezier tween blend
       */
      if (value.blendCurve) {
        newCurrent = value.blendCurve();
      }

      value.current = newCurrent;
    }

    return _Action.prototype.willRender.call(this, actor, frameStamp, elapsed);
  };

  /*
    Add active actions
     @param [number]
    @param [Action]
  */


  Flow.prototype.activateAction = function activateAction(id, action) {
    this.activeActions[id] = action;
    this.numActiveActions++;

    for (var i = 0; i < action.numValueKeys; i++) {
      var key = action.valueKeys[i];
      var actionValue = action.values[key];
      var value = this.values[key];

      // If we're blending this action, and there's on already in progress
      if (action.blend && value.numDrivers && !value.blendCurve && value.drivers[0].prototype === action.prototype) {
        value.blendCurve = (0, _generateBlendCurve2.default)(this.activeActions[value.drivers[0]], action, value, key);
      } else if (!action.isScrubbing) {
        value.blendCurve = undefined;

        // Pass Actor value properties to Action
        if (actionValue.velocity === 0) {
          actionValue.velocity = value.velocity;
        }

        if (actionValue.from === undefined) {
          actionValue.from = actionValue.current = value.current;
        }
      }

      value.drivers = [id];
      value.numDrivers = value.drivers.length;
    }

    if (this.numActiveActions) {
      _Action.prototype.start.call(this);
    }
  };

  /*
    Remove active actions
     @param [number]
  */


  Flow.prototype.deactivateAction = function deactivateAction(id) {
    var action = this.activeActions[id];

    if (action) {
      for (var i = 0; i < action.numValueKeys; i++) {
        var key = action.valueKeys[i];
        var value = this.values[key];
        var driverIndex = value.drivers.indexOf(id);

        if (driverIndex !== -1) {
          value.drivers.splice(driverIndex, 1);
          value.numDrivers--;
        }
      }

      delete this.activeActions[id];
      this.numActiveActions--;
    }

    if (!this.numActiveActions && this.isActive) {
      _Action.prototype.stop.call(this);
    }
  };

  return Flow;
}(_Action3.default);

Flow.prototype.defaultValue = _Action3.default.extendDefaultValue({
  drivers: [],
  numDrivers: 0
});

exports.default = Flow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY3Rpb25zL0Zsb3cuanMiXSwibmFtZXMiOlsiYm91bmRPblN0YXJ0IiwiYWN0aW9uIiwiZmxvdyIsImFjdGl2YXRlQWN0aW9uIiwiaWQiLCJib3VuZE9uU3RvcCIsImRlYWN0aXZhdGVBY3Rpb24iLCJib3VuZFByb3BzIiwiaXNQcmlvcml0eSIsIm9uQWN0aXZhdGUiLCJvbkRlYWN0aXZhdGUiLCJGbG93IiwicHJvcHMiLCJhY3RpdmVBY3Rpb25zIiwibnVtQWN0aXZlQWN0aW9ucyIsInNldCIsIm9uY2UiLCJjb25uZWN0IiwiaW5oZXJpdGVkQWN0aW9uIiwiaW5oZXJpdCIsIm5ld1ZhbHVlcyIsImhhc05ld1ZhbHVlcyIsImtleSIsInZhbHVlcyIsImhhc093blByb3BlcnR5IiwicGFyZW50SWQiLCJzdGFydCIsImlzQWN0aXZlIiwic3RvcCIsIndpbGxSZW5kZXIiLCJhY3RvciIsImZyYW1lU3RhbXAiLCJlbGFwc2VkIiwiaSIsIm51bVZhbHVlS2V5cyIsInZhbHVlS2V5cyIsInZhbHVlIiwiZHJpdmVyIiwibnVtRHJpdmVycyIsImRyaXZlcnMiLCJuZXdDdXJyZW50IiwiY3VycmVudCIsImJsZW5kQ3VydmUiLCJhY3Rpb25WYWx1ZSIsImJsZW5kIiwicHJvdG90eXBlIiwiaXNTY3J1YmJpbmciLCJ1bmRlZmluZWQiLCJ2ZWxvY2l0eSIsImZyb20iLCJsZW5ndGgiLCJkcml2ZXJJbmRleCIsImluZGV4T2YiLCJzcGxpY2UiLCJkZWZhdWx0VmFsdWUiLCJleHRlbmREZWZhdWx0VmFsdWUiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7OztBQUNBOzs7Ozs7Ozs7Ozs7QUFFQTs7O0FBR0EsSUFBTUEsZUFBZSxVQUFDQyxNQUFEO0FBQUEsU0FBWUEsT0FBT0MsSUFBUCxDQUFZQyxjQUFaLENBQTJCRixPQUFPRyxFQUFsQyxFQUFzQ0gsTUFBdEMsQ0FBWjtBQUFBLENBQXJCO0FBQ0EsSUFBTUksY0FBYyxVQUFDSixNQUFEO0FBQUEsU0FBWUEs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VCxFQUFuQixDQUFQO0FBQ0EsV0FBS1UsZ0JBQUw7QUFDRDs7QUFFRCxRQUFJLENBQUMsS0FBS0EsZ0JBQU4sSUFBMEIsS0FBS2EsUUFBbkMsRUFBNkM7QUFDM0Msd0JBQU1DLElBQU47QUFDRDtBQUNGLEc7O1NBbktHakIsSTs7O0FBc0tOQSxLQUFLa0MsU0FBTCxDQUFlUyxZQUFmLEdBQThCLGlCQUFPQyxrQkFBUCxDQUEwQjtBQUN0RGhCLFdBQVMsRUFENkM7QUFFdERELGNBQVk7QUFGMEMsQ0FBMUIsQ0FBOUI7O2tCQUtlM0IsSSIsImZpbGUiOiJGbG93LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFjdGlvbiBmcm9tICcuLi9hY3Rpb25zL0FjdGlvbic7XG5pbXBvcnQgZ2VuZXJhdGVCbGVuZEN1cnZlIGZyb20gJy4vZmxvdy9nZW5lcmF0ZS1ibGVuZC1jdXJ2ZSc7XG5cbi8qXG4gIE1ldGhvZHMgYW5kIHByb3BlcnRpZXMgdG8gYWRkIHRvIGJvdW5kIEFjdGlvbnNcbiovXG5jb25zdCBib3VuZE9uU3RhcnQgPSAoYWN0aW9uKSA9PiBhY3Rpb24uZmxvdy5hY3RpdmF0ZUFjdGlvbihhY3Rpb24uaWQsIGFjdGlvbik7XG5jb25zdCBib3VuZE9uU3RvcCA9IChhY3Rpb24pID0+IGFjdGlvbi5mbG93LmRlYWN0aXZhdGVBY3Rpb24oYWN0aW9uLmlkKTtcbmNvbnN0IGJvdW5kUHJvcHMgPSAoZmxvdykgPT4gKHtcbiAgZmxvdyxcbiAgaXNQcmlvcml0eTogdHJ1ZSxcbiAgb25BY3RpdmF0ZTogYm91bmRPblN0YXJ0LFxuICBvbkRlYWN0aXZhdGU6IGJvdW5kT25TdG9wXG59KTtcblxuY2xhc3MgRmxvdyBleHRlbmRzIEFjdGlvbiB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuYWN0aXZlQWN0aW9ucyA9IHt9O1xuICAgIHRoaXMubnVtQWN0aXZlQWN0aW9ucyA9IDA7XG4gIH1cblxuICBzZXQocHJvcHMpIHtcbiAgICBzdXBlci5zZXQocHJvcHMpO1xuXG4gICAgdGhpcy5vbmNlKCk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qXG4gICAgQmluZCBBY3Rpb24gdG8gQWN0b3JcbiAgKi9cbiAgY29ubmVjdChhY3Rpb24pIHtcbiAgICBjb25zdCBpbmhlcml0ZWRBY3Rpb24gPSBhY3Rpb24uaW5oZXJpdCgpO1xuICAgIGxldCBuZXdWYWx1ZXMgPSB7fTtcbiAgICBsZXQgaGFzTmV3VmFsdWVzID0gZmFsc2U7XG5cbiAgICAvLyBDcmVhdGUgdmFsdWVzIG9uIGFjdG9yIHRoYXQgZG9uJ3QgZXhpc3RcbiAgICBmb3IgKGxldCBrZXkgaW4gaW5oZXJpdGVkQWN0aW9uLnZhbHVlcykge1xuICAgICAgaWYgKGluaGVyaXRlZEFjdGlvbi52YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdGhpcy52YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBuZXdWYWx1ZXNba2V5XSA9IHt9O1xuICAgICAgICBoYXNOZXdWYWx1ZXMgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChoYXNOZXdWYWx1ZXMpIHtcbiAgICAgIHRoaXMuc2V0KHsgdmFsdWVzOiBuZXdWYWx1ZXMgfSk7XG4gICAgfVxuXG4gICAgaW5oZXJpdGVkQWN0aW9uLnBhcmVudElkID0gYWN0aW9uLmlkO1xuXG4gICAgcmV0dXJuIGluaGVyaXRlZEFjdGlvbi5zZXQoYm91bmRQcm9wcyh0aGlzLCBpbmhlcml0ZWRBY3Rpb24pKTtcbiAgfVxuXG4gIC8qXG4gICAgU3RhcnQgQWN0b3JcblxuICAgIElmIEFjdGlvbiBpcyBwcm92aWRlZCwgYmluZCBpdCB0byB0aGlzIEFjdG9yIGFuZCBzdGFydFxuXG4gICAgQHBhcmFtIChvcHRpb25hbCkgW0FjdGlvbl1cbiAgKi9cbiAgc3RhcnQoKSB7XG4gICAgc3VwZXIuc3RhcnQoKTtcblxuICAgIGZvciAobGV0IGtleSBpbiB0aGlzLmFjdGl2ZUFjdGlvbnMpIHtcbiAgICAgIGlmICh0aGlzLmFjdGl2ZUFjdGlvbnMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb25zdCBhY3Rpb24gPSB0aGlzLmFjdGl2ZUFjdGlvbnNba2V5XTtcbiAgICAgICAgaWYgKCFhY3Rpb24uaXNBY3RpdmUpIHtcbiAgICAgICAgICBhY3Rpb24uc3RhcnQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc3RvcCgpIHtcbiAgICBzdXBlci5zdG9wKCk7XG5cbiAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5hY3RpdmVBY3Rpb25zKSB7XG4gICAgICBpZiAodGhpcy5hY3RpdmVBY3Rpb25zLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVBY3Rpb25zW2tleV0uc3RvcCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2lsbFJlbmRlcihhY3RvciwgZnJhbWVTdGFtcCwgZWxhcHNlZCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5udW1WYWx1ZUtleXM7IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gdGhpcy52YWx1ZUtleXNbaV07XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMudmFsdWVzW2tleV07XG4gICAgICBjb25zdCBkcml2ZXIgPSB2YWx1ZS5udW1Ecml2ZXJzID8gdGhpcy5hY3RpdmVBY3Rpb25zW3ZhbHVlLmRyaXZlcnNbMF1dIDogZmFsc2U7XG4gICAgICBsZXQgbmV3Q3VycmVudCA9IHZhbHVlLm51bURyaXZlcnMgPyBkcml2ZXIudmFsdWVzW2tleV0uY3VycmVudCA6IHZhbHVlLmN1cnJlbnQ7XG5cbiAgICAgIC8qKlxuICAgICAgICogVE9ETzogcmVwbGFjZSB3aXRoIGJsZW5kIHRyZWUgcmVzb2x2ZXJcbiAgICAgICAqIEFkZGl0aXZlIG1vdGlvblxuICAgICAgICogQmV6aWVyIHR3ZWVuIGJsZW5kXG4gICAgICAgKi9cbiAgICAgIGlmICh2YWx1ZS5ibGVuZEN1cnZlKSB7XG4gICAgICAgIG5ld0N1cnJlbnQgPSB2YWx1ZS5ibGVuZEN1cnZlKCk7XG4gICAgICB9XG5cbiAgICAgIHZhbHVlLmN1cnJlbnQgPSBuZXdDdXJyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci53aWxsUmVuZGVyKGFjdG9yLCBmcmFtZVN0YW1wLCBlbGFwc2VkKTtcbiAgfVxuXG4gIC8qXG4gICAgQWRkIGFjdGl2ZSBhY3Rpb25zXG5cbiAgICBAcGFyYW0gW251bWJlcl1cbiAgICBAcGFyYW0gW0FjdGlvbl1cbiAgKi9cbiAgYWN0aXZhdGVBY3Rpb24oaWQsIGFjdGlvbikge1xuICAgIHRoaXMuYWN0aXZlQWN0aW9uc1tpZF0gPSBhY3Rpb247XG4gICAgdGhpcy5udW1BY3RpdmVBY3Rpb25zKys7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFjdGlvbi5udW1WYWx1ZUtleXM7IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnZhbHVlS2V5c1tpXTtcbiAgICAgIGNvbnN0IGFjdGlvblZhbHVlID0gYWN0aW9uLnZhbHVlc1trZXldO1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlc1trZXldO1xuXG4gICAgICAvLyBJZiB3ZSdyZSBibGVuZGluZyB0aGlzIGFjdGlvbiwgYW5kIHRoZXJlJ3Mgb24gYWxyZWFkeSBpbiBwcm9ncmVzc1xuICAgICAgaWYgKGFjdGlvbi5ibGVuZCAmJiB2YWx1ZS5udW1Ecml2ZXJzICYmICF2YWx1ZS5ibGVuZEN1cnZlICYmICh2YWx1ZS5kcml2ZXJzWzBdLnByb3RvdHlwZSA9PT0gYWN0aW9uLnByb3RvdHlwZSkpIHtcbiAgICAgICAgdmFsdWUuYmxlbmRDdXJ2ZSA9IGdlbmVyYXRlQmxlbmRDdXJ2ZSh0aGlzLmFjdGl2ZUFjdGlvbnNbdmFsdWUuZHJpdmVyc1swXV0sIGFjdGlvbiwgdmFsdWUsIGtleSk7XG4gICAgICB9IGVsc2UgaWYgKCFhY3Rpb24uaXNTY3J1YmJpbmcpIHtcbiAgICAgICAgdmFsdWUuYmxlbmRDdXJ2ZSA9IHVuZGVmaW5lZDtcblxuICAgICAgICAvLyBQYXNzIEFjdG9yIHZhbHVlIHByb3BlcnRpZXMgdG8gQWN0aW9uXG4gICAgICAgIGlmIChhY3Rpb25WYWx1ZS52ZWxvY2l0eSA9PT0gMCkge1xuICAgICAgICAgIGFjdGlvblZhbHVlLnZlbG9jaXR5ID0gdmFsdWUudmVsb2NpdHk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWN0aW9uVmFsdWUuZnJvbSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgYWN0aW9uVmFsdWUuZnJvbSA9IGFjdGlvblZhbHVlLmN1cnJlbnQgPSB2YWx1ZS5jdXJyZW50O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHZhbHVlLmRyaXZlcnMgPSBbaWRdO1xuICAgICAgdmFsdWUubnVtRHJpdmVycyA9IHZhbHVlLmRyaXZlcnMubGVuZ3RoO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm51bUFjdGl2ZUFjdGlvbnMpIHtcbiAgICAgIHN1cGVyLnN0YXJ0KCk7XG4gICAgfVxuICB9XG5cbiAgLypcbiAgICBSZW1vdmUgYWN0aXZlIGFjdGlvbnNcblxuICAgIEBwYXJhbSBbbnVtYmVyXVxuICAqL1xuICBkZWFjdGl2YXRlQWN0aW9uKGlkKSB7XG4gICAgY29uc3QgYWN0aW9uID0gdGhpcy5hY3RpdmVBY3Rpb25zW2lkXTtcblxuICAgIGlmIChhY3Rpb24pIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWN0aW9uLm51bVZhbHVlS2V5czsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IGFjdGlvbi52YWx1ZUtleXNbaV07XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZXNba2V5XTtcbiAgICAgICAgY29uc3QgZHJpdmVySW5kZXggPSB2YWx1ZS5kcml2ZXJzLmluZGV4T2YoaWQpO1xuXG4gICAgICAgIGlmIChkcml2ZXJJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICB2YWx1ZS5kcml2ZXJzLnNwbGljZShkcml2ZXJJbmRleCwgMSk7XG4gICAgICAgICAgdmFsdWUubnVtRHJpdmVycy0tO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZUFjdGlvbnNbaWRdO1xuICAgICAgdGhpcy5udW1BY3RpdmVBY3Rpb25zLS07XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm51bUFjdGl2ZUFjdGlvbnMgJiYgdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgc3VwZXIuc3RvcCgpO1xuICAgIH1cbiAgfVxufVxuXG5GbG93LnByb3RvdHlwZS5kZWZhdWx0VmFsdWUgPSBBY3Rpb24uZXh0ZW5kRGVmYXVsdFZhbHVlKHtcbiAgZHJpdmVyczogW10sXG4gIG51bURyaXZlcnM6IDBcbn0pO1xuXG5leHBvcnQgZGVmYXVsdCBGbG93O1xuIl19