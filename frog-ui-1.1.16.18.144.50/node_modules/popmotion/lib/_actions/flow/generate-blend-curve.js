'use strict';

exports.__esModule = true;

var _calc = require('../../inc/calc');

var BLEND_ACCURACY = 60;

exports.default = function (outAction, inAction, flowValue, key) {
  var outValue = outAction.values[key];

  if (outAction.elapsed === undefined || !outValue) {
    return;
  }

  var inValue = inAction.values[key];
  var outTotalDuration = outValue.delay + outValue.duration;
  var timeUntilOutEnd = Math.min(outTotalDuration - outAction.elapsed, inValue.delay + inValue.duration);
  var inPositionAtOutEnd = (0, _calc.ease)((0, _calc.restrict)((0, _calc.getProgressFromValue)(timeUntilOutEnd, 0, inValue.delay + inValue.duration), 0, 1), inValue.from, inValue.to, inValue.ease);
  var inBiggerThanOutAtStart = inValue.from > outValue.current;
  var inBiggerThanOutAtEnd = inPositionAtOutEnd > outValue.to;
  var tweensIntersect = inBiggerThanOutAtStart !== inBiggerThanOutAtEnd;

  var blendCurve = [[0, outValue.current], [timeUntilOutEnd, inPositionAtOutEnd]];

  // If tweens intersect, resolve tweens at a resolution to find exactly where
  if (tweensIntersect) {
    var timeStepToTest = timeUntilOutEnd / BLEND_ACCURACY;
    var foundP1 = false;
    var foundP2 = false;

    for (var i = 0; i <= BLEND_ACCURACY; i++) {
      var timeStep = i * timeStepToTest;
      var outAtTime = (0, _calc.ease)((0, _calc.getProgressFromValue)(outAction.elapsed + timeStep, outValue.delay, outValue.duration), outValue.from, outValue.to, outValue.ease);
      var inAtTime = (0, _calc.ease)((0, _calc.getProgressFromValue)(inAction.elapsed + timeStep, inValue.delay, inValue.duration), inValue.from, inValue.to, inValue.ease);

      if (!foundP1 && (inBiggerThanOutAtStart && inAtTime < outAtTime || !inBiggerThanOutAtStart && inAtTime > outAtTime)) {
        blendCurve.splice(1, 0, [timeStep, inAtTime]);
        foundP1 = true;
      }

      if (foundP1 && (inBiggerThanOutAtStart && inAtTime < outValue.current || !inBiggerThanOutAtStart && inAtTime > outValue.current)) {
        blendCurve[2] = [timeStep, inAtTime];
        foundP2 = true;
      }

      if (foundP2) {
        break;
      }
    }
  }

  if (blendCurve.length === 2) {
    // Pass between tweens using incoming easing if just two points
    return function () {
      var blendProgress = (0, _calc.restrict)((0, _calc.getProgressFromValue)(inAction.elapsed, blendCurve[0][0], blendCurve[1][0]), 0, 1);

      if (blendProgress === 1) {
        flowValue.blendCurve = undefined;
      }

      return (0, _calc.ease)(blendProgress, outValue.current, inValue.current, inValue.ease);
    };
  } else {
    // Pass between tweens using bezier interpolation
    return function () {
      var blendProgress = (0, _calc.restrict)((0, _calc.getProgressFromValue)(inAction.elapsed, blendCurve[0][0], blendCurve[2][0]), 0, 1);
      var aP = (0, _calc.getValueFromProgress)(blendProgress, blendCurve[0][1], blendCurve[1][1]);
      var bP = (0, _calc.getValueFromProgress)(blendProgress, blendCurve[1][1], blendCurve[2][1]);

      if (blendProgress === 1) {
        flowValue.blendCurve = undefined;
        return inValue.current;
      }

      return (0, _calc.getValueFromProgress)(blendProgress, aP, bP);
    };
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9fYWN0aW9ucy9mbG93L2dlbmVyYXRlLWJsZW5kLWN1cnZlLmpzIl0sIm5hbWVzIjpbIkJMRU5EX0FDQ1VSQUNZIiwib3V0QWN0aW9uIiwiaW5BY3Rpb24iLCJmbG93VmFsdWUiLCJrZXkiLCJvdXRWYWx1ZSIsInZhbHVlcyIsImVsYXBzZWQiLCJ1bmRlZmluZWQiLCJpblZhbHVlIiwib3V0VG90YWxEdXJhdGlvbiIsImRlbGF5IiwiZHVyYXRpb24iLCJ0aW1lVW50aWxPdXRFbmQiLCJNYXRoIiwibWluIiwiaW5Qb3NpdGlvbkF0T3V0RW5kIiwiZnJvbSIsInRvIiwiZWFzZSIsImluQmlnZ2VyVGhhbk91dEF0U3RhcnQiLCJjdXJyZW50IiwiaW5CaWdnZXJUaGFuT3V0QXRFbmQiLCJ0d2VlbnNJbnRlcnNlY3QiLCJibGVuZEN1cnZlIiwidGltZVN0ZXBUb1Rlc3QiLCJmb3VuZFAxIiwiZm91bmRQMiIsImkiLCJ0aW1lU3RlcCIsIm91dEF0VGltZSIsImluQXRUaW1lIiwic3BsaWNlIiwibGVuZ3RoIiwiYmxlbmRQcm9ncmVzcyIsImFQIiwiYlAiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7QUFFQSxJQUFNQSxpQkFBaUIsRUFBdkI7O2tCQUVlLFVBQUNDLFNBQUQsRUFBWUMsUUFBWixFQUFzQkMsU0FBdEIsRUFBaUNDLEdBQWpDLEVBQXlDO0FBQ3RELE1BQU1DLFdBQVdKLFVBQVVLLE1BQVYsQ0FBaUJGLEdBQWpCLENBQWpCOztBQUVBLE1BQUlILFVBQVVNLE9BQVYsS0FBc0JDLFNBQXRCLElBQW1DLENBQUNILFFBQXhDLEVBQWtEO0FBQ2hEO0FBQ0Q7O0FBRUQsTUFBTUksVUFBVVAsU0FBU0ksTUFBVCxDQUFnQkYsR0FBaEIsQ0FBaEI7QUFDQSxNQUFNTSxtQkFBbUJMLFNBQVNNLEtBQVQsR0FBaUJOLFNBQVNPLFFBQW5EO0FBQ0EsTUFBTUMsa0JBQWtCQyxLQUFLQyxHQUFMLENBQVNMLG1CQUFtQlQsVUFBVU0sT0FBdEMsRUFBK0NF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TTtBQUNYLFVBQU1lLGdCQUFnQixvQkFBUyxnQ0FBcUJoQyxTQUFTSyxPQUE5QixFQUF1Q2lCLFdBQVcsQ0FBWCxFQUFjLENBQWQsQ0FBdkMsRUFBeURBLFdBQVcsQ0FBWCxFQUFjLENBQWQsQ0FBekQsQ0FBVCxFQUFxRixDQUFyRixFQUF3RixDQUF4RixDQUF0QjtBQUNBLFVBQU1XLEtBQUssZ0NBQXFCRCxhQUFyQixFQUFvQ1YsV0FBVyxDQUFYLEVBQWMsQ0FBZCxDQUFwQyxFQUFzREEsV0FBVyxDQUFYLEVBQWMsQ0FBZCxDQUF0RCxDQUFYO0FBQ0EsVUFBTVksS0FBSyxnQ0FBcUJGLGFBQXJCLEVBQW9DVixXQUFXLENBQVgsRUFBYyxDQUFkLENBQXBDLEVBQXNEQSxXQUFXLENBQVgsRUFBYyxDQUFkLENBQXRELENBQVg7O0FBRUEsVUFBSVUsa0JBQWtCLENBQXRCLEVBQXlCO0FBQ3ZCL0Isa0JBQVVxQixVQUFWLEdBQXVCaEIsU0FBdkI7QUFDQSxlQUFPQyxRQUFRWSxPQUFmO0FBQ0Q7O0FBRUQsYUFBTyxnQ0FBcUJhLGFBQXJCLEVBQW9DQyxFQUFwQyxFQUF3Q0MsRUFBeEMsQ0FBUDtBQUNELEtBWEQ7QUFZRDtBQUNGLEMiLCJmaWxlIjoiZ2VuZXJhdGUtYmxlbmQtY3VydmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRQcm9ncmVzc0Zyb21WYWx1ZSwgZ2V0VmFsdWVGcm9tUHJvZ3Jlc3MsIGVhc2UsIHJlc3RyaWN0IH0gZnJvbSAnLi4vLi4vaW5jL2NhbGMnO1xuXG5jb25zdCBCTEVORF9BQ0NVUkFDWSA9IDYwO1xuXG5leHBvcnQgZGVmYXVsdCAob3V0QWN0aW9uLCBpbkFjdGlvbiwgZmxvd1ZhbHVlLCBrZXkpID0+IHtcbiAgY29uc3Qgb3V0VmFsdWUgPSBvdXRBY3Rpb24udmFsdWVzW2tleV07XG5cbiAgaWYgKG91dEFjdGlvbi5lbGFwc2VkID09PSB1bmRlZmluZWQgfHwgIW91dFZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgaW5WYWx1ZSA9IGluQWN0aW9uLnZhbHVlc1trZXldO1xuICBjb25zdCBvdXRUb3RhbER1cmF0aW9uID0gb3V0VmFsdWUuZGVsYXkgKyBvdXRWYWx1ZS5kdXJhdGlvbjtcbiAgY29uc3QgdGltZVVudGlsT3V0RW5kID0gTWF0aC5taW4ob3V0VG90YWxEdXJhdGlvbiAtIG91dEFjdGlvbi5lbGFwc2VkLCBpblZhbHVlLmRlbGF5ICsgaW5WYWx1ZS5kdXJhdGlvbik7XG4gIGNvbnN0IGluUG9zaXRpb25BdE91dEVuZCA9IGVhc2UocmVzdHJpY3QoZ2V0UHJvZ3Jlc3NGcm9tVmFsdWUodGltZVVudGlsT3V0RW5kLCAwLCBpblZhbHVlLmRlbGF5ICsgaW5WYWx1ZS5kdXJhdGlvbiksIDAsIDEpLCBpblZhbHVlLmZyb20sIGluVmFsdWUudG8sIGluVmFsdWUuZWFzZSk7XG4gIGNvbnN0IGluQmlnZ2VyVGhhbk91dEF0U3RhcnQgPSBpblZhbHVlLmZyb20gPiBvdXRWYWx1ZS5jdXJyZW50O1xuICBjb25zdCBpbkJpZ2dlclRoYW5PdXRBdEVuZCA9IGluUG9zaXRpb25BdE91dEVuZCA+IG91dFZhbHVlLnRvO1xuICBjb25zdCB0d2VlbnNJbnRlcnNlY3QgPSBpbkJpZ2dlclRoYW5PdXRBdFN0YXJ0ICE9PSBpbkJpZ2dlclRoYW5PdXRBdEVuZDtcblxuICBjb25zdCBibGVuZEN1cnZlID0gW1swLCBvdXRWYWx1ZS5jdXJyZW50XSwgW3RpbWVVbnRpbE91dEVuZCwgaW5Qb3NpdGlvbkF0T3V0RW5kXV07XG5cbiAgLy8gSWYgdHdlZW5zIGludGVyc2VjdCwgcmVzb2x2ZSB0d2VlbnMgYXQgYSByZXNvbHV0aW9uIHRvIGZpbmQgZXhhY3RseSB3aGVyZVxuICBpZiAodHdlZW5zSW50ZXJzZWN0KSB7XG4gICAgY29uc3QgdGltZVN0ZXBUb1Rlc3QgPSB0aW1lVW50aWxPdXRFbmQgLyBCTEVORF9BQ0NVUkFDWTtcbiAgICBsZXQgZm91bmRQMSA9IGZhbHNlO1xuICAgIGxldCBmb3VuZFAyID0gZmFsc2U7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBCTEVORF9BQ0NVUkFDWTsgaSsrKSB7XG4gICAgICBjb25zdCB0aW1lU3RlcCA9IGkgKiB0aW1lU3RlcFRvVGVzdDtcbiAgICAgIGNvbnN0IG91dEF0VGltZSA9IGVhc2UoZ2V0UHJvZ3Jlc3NGcm9tVmFsdWUob3V0QWN0aW9uLmVsYXBzZWQgKyB0aW1lU3RlcCwgb3V0VmFsdWUuZGVsYXksIG91dFZhbHVlLmR1cmF0aW9uKSwgb3V0VmFsdWUuZnJvbSwgb3V0VmFsdWUudG8sIG91dFZhbHVlLmVhc2UpO1xuICAgICAgY29uc3QgaW5BdFRpbWUgPSBlYXNlKGdldFByb2dyZXNzRnJvbVZhbHVlKGluQWN0aW9uLmVsYXBzZWQgKyB0aW1lU3RlcCwgaW5WYWx1ZS5kZWxheSwgaW5WYWx1ZS5kdXJhdGlvbiksIGluVmFsdWUuZnJvbSwgaW5WYWx1ZS50bywgaW5WYWx1ZS5lYXNlKTtcblxuICAgICAgaWYgKCFmb3VuZFAxICYmICgoaW5CaWdnZXJUaGFuT3V0QXRTdGFydCAmJiBpbkF0VGltZSA8IG91dEF0VGltZSkgfHwgKCFpbkJpZ2dlclRoYW5PdXRBdFN0YXJ0ICYmIGluQXRUaW1lID4gb3V0QXRUaW1lKSkpIHtcbiAgICAgICAgYmxlbmRDdXJ2ZS5zcGxpY2UoMSwgMCwgW3RpbWVTdGVwLCBpbkF0VGltZV0pO1xuICAgICAgICBmb3VuZFAxID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZvdW5kUDEgJiYgKChpbkJpZ2dlclRoYW5PdXRBdFN0YXJ0ICYmIGluQXRUaW1lIDwgb3V0VmFsdWUuY3VycmVudCkgfHwgKCFpbkJpZ2dlclRoYW5PdXRBdFN0YXJ0ICYmIGluQXRUaW1lID4gb3V0VmFsdWUuY3VycmVudCkpKSB7XG4gICAgICAgIGJsZW5kQ3VydmVbMl0gPSBbdGltZVN0ZXAsIGluQXRUaW1lXTtcbiAgICAgICAgZm91bmRQMiA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChmb3VuZFAyKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChibGVuZEN1cnZlLmxlbmd0aCA9PT0gMikge1xuICAgIC8vIFBhc3MgYmV0d2VlbiB0d2VlbnMgdXNpbmcgaW5jb21pbmcgZWFzaW5nIGlmIGp1c3QgdHdvIHBvaW50c1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBibGVuZFByb2dyZXNzID0gcmVzdHJpY3QoZ2V0UHJvZ3Jlc3NGcm9tVmFsdWUoaW5BY3Rpb24uZWxhcHNlZCwgYmxlbmRDdXJ2ZVswXVswXSwgYmxlbmRDdXJ2ZVsxXVswXSksIDAsIDEpO1xuXG4gICAgICBpZiAoYmxlbmRQcm9ncmVzcyA9PT0gMSkge1xuICAgICAgICBmbG93VmFsdWUuYmxlbmRDdXJ2ZSA9IHVuZGVmaW5lZDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGVhc2UoYmxlbmRQcm9ncmVzcywgb3V0VmFsdWUuY3VycmVudCwgaW5WYWx1ZS5jdXJyZW50LCBpblZhbHVlLmVhc2UpO1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgLy8gUGFzcyBiZXR3ZWVuIHR3ZWVucyB1c2luZyBiZXppZXIgaW50ZXJwb2xhdGlvblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBibGVuZFByb2dyZXNzID0gcmVzdHJpY3QoZ2V0UHJvZ3Jlc3NGcm9tVmFsdWUoaW5BY3Rpb24uZWxhcHNlZCwgYmxlbmRDdXJ2ZVswXVswXSwgYmxlbmRDdXJ2ZVsyXVswXSksIDAsIDEpO1xuICAgICAgY29uc3QgYVAgPSBnZXRWYWx1ZUZyb21Qcm9ncmVzcyhibGVuZFByb2dyZXNzLCBibGVuZEN1cnZlWzBdWzFdLCBibGVuZEN1cnZlWzFdWzFdKTtcbiAgICAgIGNvbnN0IGJQID0gZ2V0VmFsdWVGcm9tUHJvZ3Jlc3MoYmxlbmRQcm9ncmVzcywgYmxlbmRDdXJ2ZVsxXVsxXSwgYmxlbmRDdXJ2ZVsyXVsxXSk7XG5cbiAgICAgIGlmIChibGVuZFByb2dyZXNzID09PSAxKSB7XG4gICAgICAgIGZsb3dWYWx1ZS5ibGVuZEN1cnZlID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gaW5WYWx1ZS5jdXJyZW50O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZ2V0VmFsdWVGcm9tUHJvZ3Jlc3MoYmxlbmRQcm9ncmVzcywgYVAsIGJQKTtcbiAgICB9O1xuICB9XG59O1xuIl19