'use strict';

exports.__esModule = true;

var _Action2 = require('../actions/Action');

var _Action3 = _interopRequireDefault(_Action2);

var _generateBlendCurve = require('./flow/generate-blend-curve');

var _generateBlendCurve2 = _interopRequireDefault(_generateBlendCurve);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/*
  Methods and properties to add to bound Actions
*/
var boundOnStart = function (action) {
  return action.flow.activateAction(action.id, action);
};
var boundOnStop = function (action) {
  return action.flow.deactivateAction(action.id);
};
var boundProps = function (flow) {
  return {
    flow: flow,
    isPriority: true,
    onActivate: boundOnStart,
    onDeactivate: boundOnStop
  };
};

var Flow = function (_Action) {
  _inherits(Flow, _Action);

  function Flow(props) {
    _classCallCheck(this, Flow);

    var _this = _possibleConstructorReturn(this, _Action.call(this, props));

    _this.activeActions = {};
    _this.numActiveActions = 0;
    return _this;
  }

  Flow.prototype.set = function set(props) {
    _Action.prototype.set.call(this, props);

    this.once();

    return this;
  };

  /*
    Bind Action to Actor
  */


  Flow.prototype.connect = function connect(action) {
    var inheritedAction = action.inherit();
    var newValues = {};
    var hasNewValues = false;

    // Create values on actor that don't exist
    for (var key in inheritedAction.values) {
      if (inheritedAction.values.hasOwnProperty(key) && !this.values.hasOwnProperty(key)) {
        newValues[key] = {};
        hasNewValues = true;
      }
    }

    if (hasNewValues) {
      this.set({ values: newValues });
    }

    inheritedAction.parentId = action.id;

    return inheritedAction.set(boundProps(this, inheritedAction));
  };

  /*
    Start Actor
     If Action is provided, bind it to this Actor and start
     @param (optional) [Action]
  */


  Flow.prototype.start = function start() {
    _Action.prototype.start.call(this);

    for (var key in this.activeActions) {
      if (this.activeActions.hasOwnProperty(key)) {
        var action = this.activeActions[key];
        if (!action.isActive) {
          action.start();
        }
      }
    }

    return this;
  };

  Flow.prototype.stop = function stop() {
    _Action.prototype.stop.call(this);

    for (var key in this.activeActions) {
      if (this.activeActions.hasOwnProperty(key)) {
        this.activeActions[key].stop();
      }
    }

    return this;
  };

  Flow.prototype.willRender = function willRender(actor, frameStamp, elapsed) {
    for (var i = 0; i < this.numValueKeys; i++) {
      var key = this.valueKeys[i];
      var value = this.values[key];
      var driver = value.numDrivers ? this.activeActions[value.drivers[0]] : false;
      var newCurrent = value.numDrivers ? driver.values[key].current : value.current;

      /**
       * TODO: replace with blend tree resolver
       * Additive motion
       * Bezier tween blend
       */
      if (value.blendCurve) {
        newCurrent = value.blendCurve();
      }

      value.current = newCurrent;
    }

    return _Action.prototype.willRender.call(this, actor, frameStamp, elapsed);
  };

  /*
    Add active actions
     @param [number]
    @param [Action]
  */


  Flow.prototype.activateAction = function activateAction(id, action) {
    this.activeActions[id] = action;
    this.numActiveActions++;

    for (var i = 0; i < action.numValueKeys; i++) {
      var key = action.valueKeys[i];
      var actionValue = action.values[key];
      var value = this.values[key];

      // If we're blending this action, and there's on already in progress
      if (action.blend && value.numDrivers && !value.blendCurve && value.drivers[0].prototype === action.prototype) {
        value.blendCurve = (0, _generateBlendCurve2.default)(this.activeActions[value.drivers[0]], action, value, key);
      } else if (!action.isScrubbing) {
        value.blendCurve = undefined;
        // Pass Actor value properties to Action
        if (actionValue.velocity === 0) {
          actionValue.velocity = value.velocity;
        }

        if (actionValue.from === undefined) {
          actionValue.from = actionValue.current = value.current;
        }
      }

      value.drivers = [id];
      value.numDrivers = value.drivers.length;
    }

    if (this.numActiveActions) {
      _Action.prototype.start.call(this);
    }
  };

  /*
    Remove active actions
     @param [number]
  */


  Flow.prototype.deactivateAction = function deactivateAction(id) {
    var action = this.activeActions[id];

    if (action) {
      for (var i = 0; i < action.numValueKeys; i++) {
        var key = action.valueKeys[i];
        var value = this.values[key];
        var driverIndex = value.drivers.indexOf(id);

        if (driverIndex !== -1) {
          value.drivers.splice(driverIndex, 1);
          value.numDrivers--;
        }
      }

      delete this.activeActions[id];
      this.numActiveActions--;
    }

    if (!this.numActiveActions && this.isActive) {
      _Action.prototype.stop.call(this);
    }
  };

  return Flow;
}(_Action3.default);

Flow.prototype.defaultValue = _Action3.default.extendDefaultValue({
  drivers: [],
  numDrivers: 0
});

exports.default = Flow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9fYWN0aW9ucy9GbG93LmpzIl0sIm5hbWVzIjpbImJvdW5kT25TdGFydCIsImFjdGlvbiIsImZsb3ciLCJhY3RpdmF0ZUFjdGlvbiIsImlkIiwiYm91bmRPblN0b3AiLCJkZWFjdGl2YXRlQWN0aW9uIiwiYm91bmRQcm9wcyIsImlzUHJpb3JpdHkiLCJvbkFjdGl2YXRlIiwib25EZWFjdGl2YXRlIiwiRmxvdyIsInByb3BzIiwiYWN0aXZlQWN0aW9ucyIsIm51bUFjdGl2ZUFjdGlvbnMiLCJzZXQiLCJvbmNlIiwiY29ubmVjdCIsImluaGVyaXRlZEFjdGlvbiIsImluaGVyaXQiLCJuZXdWYWx1ZXMiLCJoYXNOZXdWYWx1ZXMiLCJrZXkiLCJ2YWx1ZXMiLCJoYXNPd25Qcm9wZXJ0eSIsInBhcmVudElkIiwic3RhcnQiLCJpc0FjdGl2ZSIsInN0b3AiLCJ3aWxsUmVuZGVyIiwiYWN0b3IiLCJmcmFtZVN0YW1wIiwiZWxhcHNlZCIsImkiLCJudW1WYWx1ZUtleXMiLCJ2YWx1ZUtleXMiLCJ2YWx1ZSIsImRyaXZlciIsIm51bURyaXZlcnMiLCJkcml2ZXJzIiwibmV3Q3VycmVudCIsImN1cnJlbnQiLCJibGVuZEN1cnZlIiwiYWN0aW9uVmFsdWUiLCJibGVuZCIsInByb3RvdHlwZSIsImlzU2NydWJiaW5nIiwidW5kZWZpbmVkIiwidmVsb2NpdHkiLCJmcm9tIiwibGVuZ3RoIiwiZHJpdmVySW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwiZGVmYXVsdFZhbHVlIiwiZXh0ZW5kRGVmYXVsdFZhbHVlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7Ozs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRUE7OztBQUdBLElBQU1BLGVBQWUsVUFBQ0MsTUFBRDtBQUFBLFNBQVlBLE9BQU9DLElBQVAsQ0FBWUMsY0FBWixDQUEyQkYsT0FBT0csRUFBbEMsRUFBc0NILE1BQXRDLENBQVo7QUFBQSxDQUFyQjtBQUNBLElBQU1JLGNBQWMsVUFBQ0osTUFBRDtBQUFBLFNBQVlB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VCxFQUFuQixDQUFQO0FBQ0EsV0FBS1UsZ0JBQUw7QUFDRDs7QUFFRCxRQUFJLENBQUMsS0FBS0EsZ0JBQU4sSUFBMEIsS0FBS2EsUUFBbkMsRUFBNkM7QUFDM0Msd0JBQU1DLElBQU47QUFDRDtBQUNGLEc7O1NBbEtHakIsSTs7O0FBcUtOQSxLQUFLa0MsU0FBTCxDQUFlUyxZQUFmLEdBQThCLGlCQUFPQyxrQkFBUCxDQUEwQjtBQUN0RGhCLFdBQVMsRUFENkM7QUFFdERELGNBQVk7QUFGMEMsQ0FBMUIsQ0FBOUI7O2tCQUtlM0IsSSIsImZpbGUiOiJGbG93LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFjdGlvbiBmcm9tICcuLi9hY3Rpb25zL0FjdGlvbic7XG5pbXBvcnQgZ2VuZXJhdGVCbGVuZEN1cnZlIGZyb20gJy4vZmxvdy9nZW5lcmF0ZS1ibGVuZC1jdXJ2ZSc7XG5cbi8qXG4gIE1ldGhvZHMgYW5kIHByb3BlcnRpZXMgdG8gYWRkIHRvIGJvdW5kIEFjdGlvbnNcbiovXG5jb25zdCBib3VuZE9uU3RhcnQgPSAoYWN0aW9uKSA9PiBhY3Rpb24uZmxvdy5hY3RpdmF0ZUFjdGlvbihhY3Rpb24uaWQsIGFjdGlvbik7XG5jb25zdCBib3VuZE9uU3RvcCA9IChhY3Rpb24pID0+IGFjdGlvbi5mbG93LmRlYWN0aXZhdGVBY3Rpb24oYWN0aW9uLmlkKTtcbmNvbnN0IGJvdW5kUHJvcHMgPSAoZmxvdykgPT4gKHtcbiAgZmxvdyxcbiAgaXNQcmlvcml0eTogdHJ1ZSxcbiAgb25BY3RpdmF0ZTogYm91bmRPblN0YXJ0LFxuICBvbkRlYWN0aXZhdGU6IGJvdW5kT25TdG9wXG59KTtcblxuY2xhc3MgRmxvdyBleHRlbmRzIEFjdGlvbiB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuYWN0aXZlQWN0aW9ucyA9IHt9O1xuICAgIHRoaXMubnVtQWN0aXZlQWN0aW9ucyA9IDA7XG4gIH1cblxuICBzZXQocHJvcHMpIHtcbiAgICBzdXBlci5zZXQocHJvcHMpO1xuXG4gICAgdGhpcy5vbmNlKCk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qXG4gICAgQmluZCBBY3Rpb24gdG8gQWN0b3JcbiAgKi9cbiAgY29ubmVjdChhY3Rpb24pIHtcbiAgICBjb25zdCBpbmhlcml0ZWRBY3Rpb24gPSBhY3Rpb24uaW5oZXJpdCgpO1xuICAgIGxldCBuZXdWYWx1ZXMgPSB7fTtcbiAgICBsZXQgaGFzTmV3VmFsdWVzID0gZmFsc2U7XG5cbiAgICAvLyBDcmVhdGUgdmFsdWVzIG9uIGFjdG9yIHRoYXQgZG9uJ3QgZXhpc3RcbiAgICBmb3IgKGxldCBrZXkgaW4gaW5oZXJpdGVkQWN0aW9uLnZhbHVlcykge1xuICAgICAgaWYgKGluaGVyaXRlZEFjdGlvbi52YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdGhpcy52YWx1ZXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBuZXdWYWx1ZXNba2V5XSA9IHt9O1xuICAgICAgICBoYXNOZXdWYWx1ZXMgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChoYXNOZXdWYWx1ZXMpIHtcbiAgICAgIHRoaXMuc2V0KHsgdmFsdWVzOiBuZXdWYWx1ZXMgfSk7XG4gICAgfVxuXG4gICAgaW5oZXJpdGVkQWN0aW9uLnBhcmVudElkID0gYWN0aW9uLmlkO1xuXG4gICAgcmV0dXJuIGluaGVyaXRlZEFjdGlvbi5zZXQoYm91bmRQcm9wcyh0aGlzLCBpbmhlcml0ZWRBY3Rpb24pKTtcbiAgfVxuXG4gIC8qXG4gICAgU3RhcnQgQWN0b3JcblxuICAgIElmIEFjdGlvbiBpcyBwcm92aWRlZCwgYmluZCBpdCB0byB0aGlzIEFjdG9yIGFuZCBzdGFydFxuXG4gICAgQHBhcmFtIChvcHRpb25hbCkgW0FjdGlvbl1cbiAgKi9cbiAgc3RhcnQoKSB7XG4gICAgc3VwZXIuc3RhcnQoKTtcblxuICAgIGZvciAobGV0IGtleSBpbiB0aGlzLmFjdGl2ZUFjdGlvbnMpIHtcbiAgICAgIGlmICh0aGlzLmFjdGl2ZUFjdGlvbnMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb25zdCBhY3Rpb24gPSB0aGlzLmFjdGl2ZUFjdGlvbnNba2V5XTtcbiAgICAgICAgaWYgKCFhY3Rpb24uaXNBY3RpdmUpIHtcbiAgICAgICAgICBhY3Rpb24uc3RhcnQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc3RvcCgpIHtcbiAgICBzdXBlci5zdG9wKCk7XG5cbiAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5hY3RpdmVBY3Rpb25zKSB7XG4gICAgICBpZiAodGhpcy5hY3RpdmVBY3Rpb25zLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVBY3Rpb25zW2tleV0uc3RvcCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2lsbFJlbmRlcihhY3RvciwgZnJhbWVTdGFtcCwgZWxhcHNlZCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5udW1WYWx1ZUtleXM7IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gdGhpcy52YWx1ZUtleXNbaV07XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMudmFsdWVzW2tleV07XG4gICAgICBjb25zdCBkcml2ZXIgPSB2YWx1ZS5udW1Ecml2ZXJzID8gdGhpcy5hY3RpdmVBY3Rpb25zW3ZhbHVlLmRyaXZlcnNbMF1dIDogZmFsc2U7XG4gICAgICBsZXQgbmV3Q3VycmVudCA9IHZhbHVlLm51bURyaXZlcnMgPyBkcml2ZXIudmFsdWVzW2tleV0uY3VycmVudCA6IHZhbHVlLmN1cnJlbnQ7XG5cbiAgICAgIC8qKlxuICAgICAgICogVE9ETzogcmVwbGFjZSB3aXRoIGJsZW5kIHRyZWUgcmVzb2x2ZXJcbiAgICAgICAqIEFkZGl0aXZlIG1vdGlvblxuICAgICAgICogQmV6aWVyIHR3ZWVuIGJsZW5kXG4gICAgICAgKi9cbiAgICAgIGlmICh2YWx1ZS5ibGVuZEN1cnZlKSB7XG4gICAgICAgIG5ld0N1cnJlbnQgPSB2YWx1ZS5ibGVuZEN1cnZlKCk7XG4gICAgICB9XG5cbiAgICAgIHZhbHVlLmN1cnJlbnQgPSBuZXdDdXJyZW50O1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci53aWxsUmVuZGVyKGFjdG9yLCBmcmFtZVN0YW1wLCBlbGFwc2VkKTtcbiAgfVxuXG4gIC8qXG4gICAgQWRkIGFjdGl2ZSBhY3Rpb25zXG5cbiAgICBAcGFyYW0gW251bWJlcl1cbiAgICBAcGFyYW0gW0FjdGlvbl1cbiAgKi9cbiAgYWN0aXZhdGVBY3Rpb24oaWQsIGFjdGlvbikge1xuICAgIHRoaXMuYWN0aXZlQWN0aW9uc1tpZF0gPSBhY3Rpb247XG4gICAgdGhpcy5udW1BY3RpdmVBY3Rpb25zKys7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFjdGlvbi5udW1WYWx1ZUtleXM7IGkrKykge1xuICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnZhbHVlS2V5c1tpXTtcbiAgICAgIGNvbnN0IGFjdGlvblZhbHVlID0gYWN0aW9uLnZhbHVlc1trZXldO1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlc1trZXldO1xuXG4gICAgICAvLyBJZiB3ZSdyZSBibGVuZGluZyB0aGlzIGFjdGlvbiwgYW5kIHRoZXJlJ3Mgb24gYWxyZWFkeSBpbiBwcm9ncmVzc1xuICAgICAgaWYgKGFjdGlvbi5ibGVuZCAmJiB2YWx1ZS5udW1Ecml2ZXJzICYmICF2YWx1ZS5ibGVuZEN1cnZlICYmICh2YWx1ZS5kcml2ZXJzWzBdLnByb3RvdHlwZSA9PT0gYWN0aW9uLnByb3RvdHlwZSkpIHtcbiAgICAgICAgdmFsdWUuYmxlbmRDdXJ2ZSA9IGdlbmVyYXRlQmxlbmRDdXJ2ZSh0aGlzLmFjdGl2ZUFjdGlvbnNbdmFsdWUuZHJpdmVyc1swXV0sIGFjdGlvbiwgdmFsdWUsIGtleSk7XG4gICAgICB9IGVsc2UgaWYgKCFhY3Rpb24uaXNTY3J1YmJpbmcpIHtcbiAgICAgICAgdmFsdWUuYmxlbmRDdXJ2ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgLy8gUGFzcyBBY3RvciB2YWx1ZSBwcm9wZXJ0aWVzIHRvIEFjdGlvblxuICAgICAgICBpZiAoYWN0aW9uVmFsdWUudmVsb2NpdHkgPT09IDApIHtcbiAgICAgICAgICBhY3Rpb25WYWx1ZS52ZWxvY2l0eSA9IHZhbHVlLnZlbG9jaXR5O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFjdGlvblZhbHVlLmZyb20gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGFjdGlvblZhbHVlLmZyb20gPSBhY3Rpb25WYWx1ZS5jdXJyZW50ID0gdmFsdWUuY3VycmVudDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB2YWx1ZS5kcml2ZXJzID0gW2lkXTtcbiAgICAgIHZhbHVlLm51bURyaXZlcnMgPSB2YWx1ZS5kcml2ZXJzLmxlbmd0aDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5udW1BY3RpdmVBY3Rpb25zKSB7XG4gICAgICBzdXBlci5zdGFydCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAgUmVtb3ZlIGFjdGl2ZSBhY3Rpb25zXG5cbiAgICBAcGFyYW0gW251bWJlcl1cbiAgKi9cbiAgZGVhY3RpdmF0ZUFjdGlvbihpZCkge1xuICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuYWN0aXZlQWN0aW9uc1tpZF07XG5cbiAgICBpZiAoYWN0aW9uKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFjdGlvbi5udW1WYWx1ZUtleXM7IGkrKykge1xuICAgICAgICBjb25zdCBrZXkgPSBhY3Rpb24udmFsdWVLZXlzW2ldO1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMudmFsdWVzW2tleV07XG4gICAgICAgIGNvbnN0IGRyaXZlckluZGV4ID0gdmFsdWUuZHJpdmVycy5pbmRleE9mKGlkKTtcblxuICAgICAgICBpZiAoZHJpdmVySW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgdmFsdWUuZHJpdmVycy5zcGxpY2UoZHJpdmVySW5kZXgsIDEpO1xuICAgICAgICAgIHZhbHVlLm51bURyaXZlcnMtLTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBkZWxldGUgdGhpcy5hY3RpdmVBY3Rpb25zW2lkXTtcbiAgICAgIHRoaXMubnVtQWN0aXZlQWN0aW9ucy0tO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5udW1BY3RpdmVBY3Rpb25zICYmIHRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHN1cGVyLnN0b3AoKTtcbiAgICB9XG4gIH1cbn1cblxuRmxvdy5wcm90b3R5cGUuZGVmYXVsdFZhbHVlID0gQWN0aW9uLmV4dGVuZERlZmF1bHRWYWx1ZSh7XG4gIGRyaXZlcnM6IFtdLFxuICBudW1Ecml2ZXJzOiAwXG59KTtcblxuZXhwb3J0IGRlZmF1bHQgRmxvdztcbiJdfQ==