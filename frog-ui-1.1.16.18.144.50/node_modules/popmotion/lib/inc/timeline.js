'use strict';

exports.__esModule = true;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.default = timeline;

var _Tween = require('../actions/Tween');

var _Tween2 = _interopRequireDefault(_Tween);

var _presetEasing = require('../actions/easing/preset-easing');

var _presetEasing2 = _interopRequireDefault(_presetEasing);

var _calc = require('./calc');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
  @param [array]
    Sequential array of tweens, each item can be a tween or definition obj:

    [
      new Tween(),
      stagger(),
      timeline(),
      {
        tween: new Tween(),
        at: 100,
        offset: "+=100"
      }
    ]
*/
var analyze = function (defs) {
  var timeline = [];
  var numDefs = defs.length;
  var currentPlayhead = 0;

  var _loop = function (i) {
    var def = defs[i];
    var defIsObj = def.tween ? true : false;
    var tween = defIsObj ? def.tween : def;

    if (defIsObj) {
      if (def.offset !== undefined) {
        currentPlayhead = (0, _calc.relativeValue)(currentPlayhead, def.offset);
      } else if (def.at !== undefined) {
        currentPlayhead = def.at;
      }
    }

    var duration = 0;
    for (var key in tween.values) {
      if (tween.values.hasOwnProperty(key)) {
        var value = tween.values[key];
        duration = Math.max(duration, value.duration);
      }
    }

    timeline.push({
      from: currentPlayhead,
      duration: duration,
      fire: function (time) {
        return tween.seekTime(time);
      }
    });

    currentPlayhead += duration;
  };

  for (var i = 0; i < numDefs; i++) {
    _loop(i);
  }

  return { totalTime: currentPlayhead, timeline: timeline };
};

var setTweens = function (_ref) {
  var timeline = _ref.timeline;
  var timelineLength = _ref.timelineLength;
  var values = _ref.values;
  var duration = _ref.duration;

  for (var i = 0; i < timelineLength; i++) {
    var _tween = timeline[i];
    var tweenTime = values.p.current * duration - _tween.from;

    if (tweenTime >= -50 && tweenTime <= _tween.duration + 50) {
      _tween.fire(tweenTime);
    }
  }
};

function timeline(def) {
  var props = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var _analyze = analyze(def);

  var totalTime = _analyze.totalTime;
  var timeline = _analyze.timeline;


  return new _Tween2.default(_extends({
    ease: _presetEasing2.default.linear
  }, props, {
    duration: totalTime,
    values: {
      p: { from: 0, to: 1 }
    },
    timeline: timeline,
    timelineLength: timeline.length,
    onRender: setTweens
  }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmMvdGltZWxpbmUuanMiXSwibmFtZXMiOlsidGltZWxpbmUiLCJhbmFseXplIiwiZGVmcyIsIm51bURlZnMiLCJsZW5ndGgiLCJjdXJyZW50UGxheWhlYWQiLCJpIiwiZGVmIiwiZGVmSXNPYmoiLCJ0d2VlbiIsIm9mZnNldCIsInVuZGVmaW5lZCIsImF0IiwiZHVyYXRpb24iLCJrZXkiLCJ2YWx1ZXMiLCJoYXNPd25Qcm9wZXJ0eSIsInZhbHVlIiwiTWF0aCIsIm1heCIsInB1c2giLCJmcm9tIiwiZmlyZSIsInRpbWUiLCJzZWVrVGltZSIsInRvdGFsVGltZSIsInNldFR3ZWVucyIsInRpbWVsaW5lTGVuZ3RoIiwidHdlZW5UaW1lIiwicCIsImN1cnJlbnQiLCJwcm9wcyIsImVhc2UiLCJsaW5lYXIiLCJ0byIsIm9uUmVuZGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7a0JBb0V3QkEsUTs7QUFwRXhCOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7Ozs7Ozs7Ozs7Ozs7QUFlQSxJQUFNQyxVQUFVLFVBQUNDLElBQUQsRUFBVTtBQUN4QixNQUFNRixXQUFXLEVBQWpCO0FBQ0EsTUFBTUcsVUFBVUQsS0FBS0UsTUFBckI7QUFDQSxNQUFJQyxrQkFBa0IsQ0FBdEI7O0FBSHdCLHdCQUtmQyxDQUxlO0FBTXRCLFFBQU1DLE1BQU1MLEtBQUtJLENBQUwsQ0FBWjtBQUNBLFFBQU1FLFdBQVdELElBQUlFLEtBQUosR0FBWSxJQUFaLEdBQW1CLEtBQXBDO0FBQ0EsUUFBTUEsUUFBU0QsUUFBRCxHQUFhRCxJQUFJRSxLQUFqQixHQUF5QkYsR0FBdkM7O0FBRUEsUUFBSUMsUUFBSixFQUFjO0FBQ1osVUFBSUQsSUFBSUcsTUFBSixLQUFlQyxTQUFuQixFQUE4QjtBQUM1Qk4sMEJBQWtCLHlCQUFjQSxlQUFkLEVBQStCRSxJQUFJRyxNQUFuQyxDQUFsQjtBQUNELE9BRkQsTUFFTyxJQUFJSCxJQUFJSyxFQUFKLEtBQVdELFNBQWYsRUFBMEI7QUFDL0JOLDBCQUFrQkUsSUFBSUssRUFBdEI7QUFDRDtBQUNGOztBQUVELFFBQUlDLFdBQVcsQ0FBZjtBQUNBLFNBQUssSUFBSUMsR0FBVCxJQUFnQkwsTUFBTU0sTUFBdEIsRUFBOEI7QUFDNUIsVUFBSU4sTUFBTU0sTUFBTixDQUFhQyxjQUFiLENBQTRCRixHQUE1QixDQUFKLEVBQXNDO0FBQ3BDLFlBQU1HLFFBQVFSLE1BQU1NLE1BQU4sQ0FBYUQsR0FBYixDQUFkO0FBQ0FELG1CQUFXSyxLQUFLQyxHQUFMLENBQVNOLFFBQVQsRUFBbUJJLE1BQU1KLFFBQXpCLENBQVg7QUFDRDtBQUNGOztBQUVEYixhQUFTb0IsSUFBVCxDQUFjO0FBQ1pDLFlBQU1oQixlQURNO0FBRVpRLGdCQUFVQSxRQUZFO0FBR1pTLFlBQU0sVUFBQ0MsSUFBRDtBQUFBLGVBQVVkLE1BQU1lLFFBQU4sQ0FBZUQsSUFBZixDQUFWO0FBQUE7QUFITSxLQUFkOztBQU1BbEIsdUJBQW1CUSxRQUFuQjtBQWhDc0I7O0FBS3hCLE9BQUssSUFBSVAsSUFBSSxDQUFiLEVBQWdCQSxJQUFJSCxPQUFwQixFQUE2QkcsR0FBN0IsRUFBa0M7QUFBQSxVQUF6QkEsQ0FBeUI7QUE0QmpDOztBQUVELFNBQU8sRUFBRW1CLFdBQVdwQixlQUFiLEVBQThCTCxrQkFBOUIsRUFBUDtBQUNELENBcENEOztBQXNDQSxJQUFNMEIsWUFBWSxnQkFBb0Q7QUFBQSxNQUFqRDFCLFFBQWlELFFBQWpEQSxRQUFpRDtBQUFBLE1BQXZDMkIsY0FBdUMsUUFBdkNBLGNBQXVDO0FBQUEsTUFBdkJaLE1BQXVCLFFBQXZCQSxNQUF1QjtBQUFBLE1BQWZGLFFBQWUsUUFBZkEsUUFBZTs7QUFDcEUsT0FBSyxJQUFJUCxJQUFJLENBQWIsRUFBZ0JBLElBQUlxQixjQUFwQixFQUFvQ3JCLEdBQXBDLEVBQXlDO0FBQ3ZDLFFBQU1HLFNBQVFULFNBQVNNLENBQVQsQ0FBZDtBQUNBLFFBQU1zQixZQUFhYixPQUFPYyxDQUFQLENBQVNDLE9BQVQsR0FBbUJqQixRQUFwQixHQUFnQ0osT0FBTVksSUFBeEQ7O0FBRUEsUUFBSU8sYUFBYSxDQUFDLEVBQWQsSUFBb0JBLGFBQWFuQixPQUFNSSxRQUFOLEdBQWlCLEVBQXRELEVBQTBEO0FBQ3hESixhQUFNYSxJQUFOLENBQVdNLFNBQVg7QUFDRDtBQUNGO0FBQ0YsQ0FURDs7QUFXZSxTQUFTNUIsUUFBVCxDQUFrQk8sR0FBbEIsRUFBbUM7QUFBQSxNQUFad0IsS0FBWSx5REFBSixFQUFJOztBQUFBLGlCQUNoQjlCLFFBQVFNLEdBQVIsQ0FEZ0I7O0FBQUEsTUFDeENrQixTQUR3QyxZQUN4Q0EsU0FEd0M7QUFBQSxNQUM3QnpCLFFBRDZCLFlBQzdCQSxRQUQ2Qjs7O0FBR2hELFNBQU87QUFDTGdDLFVBQU0sdUJBQU9DO0FBRFIsS0FFRkYsS0FGRTtBQUdMbEIsY0FBVVksU0FITDtBQUlMVixZQUFRO0FBQ05jLFNBQUcsRUFBRVIsTUFBTSxDQUFSLEVBQVdhLElBQUksQ0FBZjtBQURHLEtBSkg7QUFPTGxDLGNBQVVBLFFBUEw7QUFRTDJCLG9CQUFnQjNCLFNBQVNJLE1BUnBCO0FBU0wrQixjQUFVVDtBQVRMLEtBQVA7QUFXRCIsImZpbGUiOiJ0aW1lbGluZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUd2VlbiBmcm9tICcuLi9hY3Rpb25zL1R3ZWVuJztcbmltcG9ydCBlYXNpbmcgZnJvbSAnLi4vYWN0aW9ucy9lYXNpbmcvcHJlc2V0LWVhc2luZyc7XG5pbXBvcnQgeyByZWxhdGl2ZVZhbHVlIH0gZnJvbSAnLi9jYWxjJztcblxuLypcbiAgQHBhcmFtIFthcnJheV1cbiAgICBTZXF1ZW50aWFsIGFycmF5IG9mIHR3ZWVucywgZWFjaCBpdGVtIGNhbiBiZSBhIHR3ZWVuIG9yIGRlZmluaXRpb24gb2JqOlxuXG4gICAgW1xuICAgICAgbmV3IFR3ZWVuKCksXG4gICAgICBzdGFnZ2VyKCksXG4gICAgICB0aW1lbGluZSgpLFxuICAgICAge1xuICAgICAgICB0d2VlbjogbmV3IFR3ZWVuKCksXG4gICAgICAgIGF0OiAxMDAsXG4gICAgICAgIG9mZnNldDogXCIrPTEwMFwiXG4gICAgICB9XG4gICAgXVxuKi9cbmNvbnN0IGFuYWx5emUgPSAoZGVmcykgPT4ge1xuICBjb25zdCB0aW1lbGluZSA9IFtdO1xuICBjb25zdCBudW1EZWZzID0gZGVmcy5sZW5ndGg7XG4gIGxldCBjdXJyZW50UGxheWhlYWQgPSAwO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtRGVmczsgaSsrKSB7XG4gICAgY29uc3QgZGVmID0gZGVmc1tpXTtcbiAgICBjb25zdCBkZWZJc09iaiA9IGRlZi50d2VlbiA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCB0d2VlbiA9IChkZWZJc09iaikgPyBkZWYudHdlZW4gOiBkZWY7XG5cbiAgICBpZiAoZGVmSXNPYmopIHtcbiAgICAgIGlmIChkZWYub2Zmc2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY3VycmVudFBsYXloZWFkID0gcmVsYXRpdmVWYWx1ZShjdXJyZW50UGxheWhlYWQsIGRlZi5vZmZzZXQpO1xuICAgICAgfSBlbHNlIGlmIChkZWYuYXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjdXJyZW50UGxheWhlYWQgPSBkZWYuYXQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGR1cmF0aW9uID0gMDtcbiAgICBmb3IgKGxldCBrZXkgaW4gdHdlZW4udmFsdWVzKSB7XG4gICAgICBpZiAodHdlZW4udmFsdWVzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSB0d2Vlbi52YWx1ZXNba2V5XTtcbiAgICAgICAgZHVyYXRpb24gPSBNYXRoLm1heChkdXJhdGlvbiwgdmFsdWUuZHVyYXRpb24pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRpbWVsaW5lLnB1c2goe1xuICAgICAgZnJvbTogY3VycmVudFBsYXloZWFkLFxuICAgICAgZHVyYXRpb246IGR1cmF0aW9uLFxuICAgICAgZmlyZTogKHRpbWUpID0+IHR3ZWVuLnNlZWtUaW1lKHRpbWUpXG4gICAgfSk7XG5cbiAgICBjdXJyZW50UGxheWhlYWQgKz0gZHVyYXRpb247XG4gIH1cblxuICByZXR1cm4geyB0b3RhbFRpbWU6IGN1cnJlbnRQbGF5aGVhZCwgdGltZWxpbmUgfTtcbn07XG5cbmNvbnN0IHNldFR3ZWVucyA9ICh7IHRpbWVsaW5lLCB0aW1lbGluZUxlbmd0aCwgdmFsdWVzLCBkdXJhdGlvbiB9KSA9PiB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGltZWxpbmVMZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHR3ZWVuID0gdGltZWxpbmVbaV07XG4gICAgY29uc3QgdHdlZW5UaW1lID0gKHZhbHVlcy5wLmN1cnJlbnQgKiBkdXJhdGlvbikgLSB0d2Vlbi5mcm9tO1xuXG4gICAgaWYgKHR3ZWVuVGltZSA+PSAtNTAgJiYgdHdlZW5UaW1lIDw9IHR3ZWVuLmR1cmF0aW9uICsgNTApIHtcbiAgICAgIHR3ZWVuLmZpcmUodHdlZW5UaW1lKTtcbiAgICB9XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRpbWVsaW5lKGRlZiwgcHJvcHMgPSB7fSkge1xuICBjb25zdCB7IHRvdGFsVGltZSwgdGltZWxpbmUgfSA9IGFuYWx5emUoZGVmKTtcblxuICByZXR1cm4gbmV3IFR3ZWVuKHtcbiAgICBlYXNlOiBlYXNpbmcubGluZWFyLFxuICAgIC4uLnByb3BzLFxuICAgIGR1cmF0aW9uOiB0b3RhbFRpbWUsXG4gICAgdmFsdWVzOiB7XG4gICAgICBwOiB7IGZyb206IDAsIHRvOiAxIH1cbiAgICB9LFxuICAgIHRpbWVsaW5lOiB0aW1lbGluZSxcbiAgICB0aW1lbGluZUxlbmd0aDogdGltZWxpbmUubGVuZ3RoLFxuICAgIG9uUmVuZGVyOiBzZXRUd2VlbnNcbiAgfSk7XG59Il19